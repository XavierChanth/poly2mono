name: Update Diagrams
description: Update the diagrams

runs:
  using: composite
  steps:
    - uses: dart-lang/setup-dart@v1.3
      with:
        sdk: stable

    - name: Install melos
      shell: bash
      run: dart pub global activate melos

    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - uses: ts-graphviz/setup-graphviz@v1

    - name: Run melos analysis
      shell: bash
      env:
        TMP: ${{ runner.temp }}
      run: |
        melos ls -r --json -l --ignore='*example*' >> "$TMP/melos-json.json"
        melos ls -r --graph --ignore='*example*' >> "$TMP/melos-graph.json"
        melos ls -r --gviz --ignore='*example*' >> "$TMP/melos-gviz.gv"

    - name: Execute diagram generator
      shell: bash
      env:
        TMP: ${{ runner.temp }}
      run: |
        pip install -r ./tools/package_diagrams.requirements.txt
        python ./tools/package_diagrams.py "$TMP/melos-gviz.gv" "$GITHUB_WORKSPACE/docs/diagrams"

    - name: Auto commit diagrams
      uses: stefanzweifel/git-auto-commit-action@v4
      id: commit_id
      with:
        commit_message: 'docs(ci): Update docs'