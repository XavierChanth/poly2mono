name: Weekly Jobs

on:
  schedule:
    - cron: "53 4 * * 6" # 4:53 every saturday
  workflow_dispatch:
  push:

jobs:
  build_branch:
    runs-on: ubuntu-20.04
    outputs:
      build_id: ${{ steps.build.outputs.build_id }}
      branch_name: ${{ steps.branch_name.outputs.generated }}
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - name: Generate build id
        id: build
        uses: ./.github/composite/build-id

      - name: Generate Branch Name
        id: branch_name
        run: |
          echo "generated=$(date -I)" >> $GITHUB_OUTPUT

      - uses: peterjgrainger/action-create-branch@64aa569aea81305305c6e92bd236d8c427debff8 # v2.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: ${{ steps.branch_name.outputs.generated }}
          sha: ${{ steps.build.outputs.commit_ref }}

  package-analysis:
    runs-on: ubuntu-20.04
    needs:
      - build_branch
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          ref: ${{ needs.build_branch.outputs.branch_name }}
          submodules: true

      - uses: subosito/flutter-action@2783a3f08e1baf891508463f8c6653c258246225 #v2.12.0
        with:
          channel: 'stable'
          cache: ${{ needs.build_branch.outputs.build_id != '' }}
          cache-key: ${{ needs.build_branch.outputs.build_id }}

      - uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: '3.9'

      - uses: ts-graphviz/setup-graphviz@d5b2b6b67007094b256f3fd2fa6cf0ac41ceef25 # v2.0.0

      - name: Install melos
        run: dart pub get
        shell: bash

      - name: Run melos analysis
        shell: bash
        env:
          TMP: ${{ runner.temp }}
        run: |
          dart run melos ls -r --json -l --ignore='*example*' >> "$TMP/melos-json.json"
          dart run melos ls -r --graph --ignore='*example*' >> "$TMP/melos-graph.json"
          dart run melos ls -r --gviz --ignore='*example*' >> "$TMP/melos-gviz.gv"

      - name: Execute diagram generator
        shell: bash
        env:
          TMP: ${{ runner.temp }}
        run: |
          chmod +w ./docs/diagrams/*
          pip install -r ./tools/package_diagrams.requirements.txt
          python ./tools/package_diagrams.py "$TMP/melos-gviz.gv" "$GITHUB_WORKSPACE/docs/diagrams"

      - name: create pull request
        run: |
          gh pr create -B trunk -H ${{ needs.build_branch.outputs.branch_name }} --title 'ci: backup ${{ needs.backup.outputs.branch_name }}'
